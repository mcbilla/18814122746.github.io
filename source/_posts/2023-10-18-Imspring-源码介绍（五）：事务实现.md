---
title: Imspring 源码介绍（五）：事务实现
date: 2023-10-18 20:42:58
categories:
- Spring
tags:
- Spring
---

> Imspring 源码介绍（五）：事务实现

<!--more-->

Spring 事务依赖于底层数据库对事务的支持，如果底层数据库不支持事务，Spring 事务就会失效。

Spring 事务基于数据库事务提供一套抽象的事务管理接口，底层由各数据库自己实现，并结合 Spring AOP 实现声明式事务，可以做到对程序无侵入实现事务功能，简化了程序使用事务的步骤。

在介绍 Spring 事务之前，先简单事务的一些基本概念。

# 基本概念

## 事务ACID特性

## 事务隔离级别



Spring 比 mysql 多了一种 default，表示使用数据库默认的事务隔离级别。

## 事务传播行为

Spring 事务传播行为是 Spring 为了业务层之间调用事务的关系而提出的，即数据库层面是不存在事务传播行为的。

Spring中存在7种传播属性：

如果存在当前事务可分4类，

1、按照当前事务继续处理

REQUIRED：如果没有事务则重新建立一个。spring默认的事务的传播;

SUPPORTS：如果没有事务,就啥也不干;

MANDATORY：如果当前没有事务，就抛出异常;

2、挂起当前事务

REQUIRES_NEW：如果当前没有事务,新建事务,是两个独立的事务;

NOT_SUPPORTED：如果当前没有事务,以非事务方式执行操作;

3、抛出异常

NEVER：如果当前没有事务,以非事务方式执行。

4、嵌套在当前的事务中

## Spring 事务组件



## 事务失效

1. 未启用spring事务管理功能: @EnableTransactionManagement 注解用来启用spring事务自动管理事务的功能。

2. 方法不是public类型的：@Transaction用在了非public方法上，事务将无效。
3. 数据源未配置事务管理器：spring是通过事务管理器了来管理事务，每个数据源都要配置。
4. 自身调用问题: @Transactional中有AOP的逻辑会拦截异常会导致传播事务失效，只有在代理对象之间进行调用时，才会触发切面逻辑。可以在类中注入该类代理对象，然后在嵌套的方法中调用代理对象的方法。
5. 异常类型错误：默认情况下，RuntimeException和Error的情况下，spring事务才会回滚。也可以自定义回滚的异常类型，@Transactional(rollbackFor = {异常类型列表})。
6. 异常被吞：在方法中吞没异常。
7. 业务和spring事务代码必须在一个线程中：spring事务实现中使用了ThreadLocal，要求业务代码必须和spring事务的源码执行过程必须在一个线程中，才会受spring事务的控制。
